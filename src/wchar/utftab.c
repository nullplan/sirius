#include <wchar.h>

/* we need to store the state of the conversion
 * for mbrtowc(), to be able to pick it up again later.
 * The idea here is that since each new byte adds six value bits,
 * I try to encode the information about what continuation bytes
 * are allowed in six bits, so the information is shifted out as new
 * data is shifted in.
 *
 * In UTF-8, the lead byte immediately sets the number and limits of the continuation
 * bytes. Normally, all continuation bytes can be bytes in the range 0x80 - 0xBF. However,
 * there are exceptions:
 *
 * - Lowest possible lead byte for a multibyte sequence is 0xC2, since 0xC0 and 0xC1 would lead
 *   to a value that can be encoded in a single byte.
 * - After 0xE0, the next byte must be between 0xA0 and 0xBF, since otherwise the encoding
 *   could be a two byte encoding.
 * - After 0xF0, the next byte must be between 0x90 and 0xBF, since otherwise the encoding
 *   could be a three byte encoding.
 * - Highest possible lead byte is 0xF4, and the byte after that must be between 0x80 and 0x8F,
 *   since otherwise the encoding is 0x110000 or higher.
 *
 *
 * Encoding     Value bits      Code point range    Lowest encoding Highest encoding
 * =================================================================================
 * 1 byte       7               00 - 7F             00              7F
 * 2 byte       11              80 - 7FF            C2 00           DF BF
 * 3 byte       16              800 - FFFF          E0 A0 80        EF BF BF
 * 4 byte       21              10000 - 10FFFF      F0 90 80 80     F4 8F BF BF
 *
 * So I need to encode the value ranges 80-BF, 90-BF, A0-BF, 80-8F in such a way that
 * - the encoding takes 6 bits
 * - the highest bit is set
 * - determining OOB is easy.
 *
 * I choose to encode the base high nibble, followed by the allowed range for that nibble.
 */
#define R(base,range)     (((base) + 0ul) <<28 | (range)<<26)
hidden const unsigned __utftab[0xf4 - 0xc2 + 1] = {
    [0xc2 - 0xc2] = R(0x8,3) | 0x2,
    [0xc3 - 0xc2] = R(0x8,3) | 0x3,
    [0xc4 - 0xc2] = R(0x8,3) | 0x4,
    [0xc5 - 0xc2] = R(0x8,3) | 0x5,
    [0xc6 - 0xc2] = R(0x8,3) | 0x6,
    [0xc7 - 0xc2] = R(0x8,3) | 0x7,
    [0xc8 - 0xc2] = R(0x8,3) | 0x8,
    [0xc9 - 0xc2] = R(0x8,3) | 0x9,
    [0xca - 0xc2] = R(0x8,3) | 0xa,
    [0xcb - 0xc2] = R(0x8,3) | 0xb,
    [0xcc - 0xc2] = R(0x8,3) | 0xc,
    [0xcd - 0xc2] = R(0x8,3) | 0xd,
    [0xce - 0xc2] = R(0x8,3) | 0xe,
    [0xcf - 0xc2] = R(0x8,3) | 0xf,
    [0xd0 - 0xc2] = R(0x8,3) | 0x10,
    [0xd1 - 0xc2] = R(0x8,3) | 0x11,
    [0xd2 - 0xc2] = R(0x8,3) | 0x12,
    [0xd3 - 0xc2] = R(0x8,3) | 0x13,
    [0xd4 - 0xc2] = R(0x8,3) | 0x14,
    [0xd5 - 0xc2] = R(0x8,3) | 0x15,
    [0xd6 - 0xc2] = R(0x8,3) | 0x16,
    [0xd7 - 0xc2] = R(0x8,3) | 0x17,
    [0xd8 - 0xc2] = R(0x8,3) | 0x18,
    [0xd9 - 0xc2] = R(0x8,3) | 0x19,
    [0xda - 0xc2] = R(0x8,3) | 0x1a,
    [0xdb - 0xc2] = R(0x8,3) | 0x1b,
    [0xdc - 0xc2] = R(0x8,3) | 0x1c,
    [0xdd - 0xc2] = R(0x8,3) | 0x1d,
    [0xde - 0xc2] = R(0x8,3) | 0x1e,
    [0xdf - 0xc2] = R(0x8,3) | 0x1f,
    [0xe0 - 0xc2] = R(0xa,1) | R(0x8,3) >> 6 | 0x0,
    [0xe1 - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | 0x1,
    [0xe2 - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | 0x2,
    [0xe3 - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | 0x3,
    [0xe4 - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | 0x4,
    [0xe5 - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | 0x5,
    [0xe6 - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | 0x6,
    [0xe7 - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | 0x7,
    [0xe8 - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | 0x8,
    [0xe9 - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | 0x9,
    [0xea - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | 0xa,
    [0xeb - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | 0xb,
    [0xec - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | 0xc,
    [0xed - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | 0xd,
    [0xee - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | 0xe,
    [0xef - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | 0xf,
    [0xf0 - 0xc2] = R(0x9,2) | R(0x8,3) >> 6 | R(0x8,3) >> 12 | 0x0,
    [0xf1 - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | R(0x8,3) >> 12 | 0x1,
    [0xf2 - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | R(0x8,3) >> 12 | 0x2,
    [0xf3 - 0xc2] = R(0x8,3) | R(0x8,3) >> 6 | R(0x8,3) >> 12 | 0x3,
    [0xf4 - 0xc2] = R(0x8,0) | R(0x8,3) >> 6 | R(0x8,3) >> 12 | 0x4,
};
